const getEnvPath=e=>{switch(e){case"dev":return"dev.pdp.gokwik.co";case"production":default:return"pdp.gokwik.co";case"sandbox":return"sandbox.pdp.gokwik.co";case"qa":return"qa.pdp.gokwik.co"}},CORE_FUNCTION_EVENTS=Object.freeze({LOGOUT_BUTTON_CLICK:"kp_logout_button_click",SUCCESSFULLY_LOGGED_OUT:"kp_successfully_logged_out",REDIRECRED_TO_ACCOUNT_PAGE:"kp_redirected_to_account_page",process_fingerprinting:"process_fingerprinting",store_visitor_information:"store_visitor_information",store_data_from_merchant:"store_data_from_merchant",kp_vst_cnt:"kp_vst_cnt"}),COUNTRY_CODE_INDIA="+91",CORE_TOKEN_SESSION_TYPE=Object.freeze({VERIFIED:"verified",KP_SESSION:"kp_session_type",KP_VALID_SESSION:"kp_valid_session"});function processMessageQueue(){if(!window.IS_KP_IFRAME_LOADED)return;const e=document.getElementById("iframe-kp")||document.getElementById("process-sso");if(e&&e.contentWindow)for(;window.KP_MESSAGE_QUEUE.length>0;){const o=getValueFromCookiesOrLocalStorage("kp-request-id"),t=window.KP_MESSAGE_QUEUE.shift();0==window.kp_health_status?(document.getElementById("kp-login-button-header-logo")?.addEventListener("click",(()=>{window.location.href="/account"})),document.getElementById("kp-login-button-header-logo-mobile")?.addEventListener("click",(()=>{window.location.href="/account"}))):e.contentWindow.postMessage({...t,requestId:o},"*")}}function openIframe(e="",o=null){const t=getNotifyPh("non_authed_info"),n=getNotifyPh("kp_non_otp_verified_user"),i=getNotifyPh("kpUnauthPhoneNumber"),r=getValueFromCookiesOrLocalStorage("kp_user_id");let a={type:"process-sso",event:e,mid:window.merchantInfo.mid,isLogout:sessionStorage.getItem("isLogout"),userId:r};o&&(e===CORE_FUNCTION_EVENTS.process_fingerprinting?a.visitorId=o:e===CORE_FUNCTION_EVENTS.store_visitor_information?a.visitorInfo=o:e===CORE_FUNCTION_EVENTS.store_data_from_merchant?a.queryparams=o:e===CORE_FUNCTION_EVENTS.kp_vst_cnt&&o?.m_count?a.mCount=o?.m_count:e===CORE_FUNCTION_EVENTS.kp_vst_cnt&&o?.m_kp_count?a.mKpCount=o?.m_kp_count:a.kcPhone=o),t?.value&&(a.nonAuthedInfo=t),n?.value&&(a.nonOtpVerifiedPhone=n),i?.value&&(a.appUnauthPhoneNumber=i),window.KP_MESSAGE_QUEUE.push(a);let s=document.getElementById("iframe-kp");const c=function(){window.IS_KP_IFRAME_LOADED=!0,window.removeEventListener("kp_iframe_loaded",processMessageQueue),processMessageQueue()};window.addEventListener("kp_iframe_loaded",processMessageQueue),s&&(s.contentWindow&&window.IS_KP_IFRAME_LOADED&&c(),s.onload=function(){c()})}function getDeviceWidth(){return window.innerWidth}function checkCookieExists(e){const o=document.cookie.split(";");for(const t of o){const[o]=t.split("=").map((e=>e.trim()));if(o===e)return!0}return!1}function kpGetCookieValue(e){const o=document.cookie.split(";").map((e=>e.trim()));for(const t of o){const[o,n]=t.split("=");if(o===e)return n}return null}function kpGetLocalStorageValue(e,o=!0){return o&&localStorage.getItem(e)}function kpSetCookie(e,o,t,n=!1,i){let r="",a="";if(t||i){const e=new Date;t&&e.setDate(e.getDate()+t),i&&e.setTime(e.getTime()+60*i*1e3),r="; expires="+e.toUTCString()}n&&(a=";domain="+getPdpUrl()),document.cookie=e+"="+(o||"")+r+"; SameSite=None; Secure; path=/"+a}function getValueFromCookiesOrLocalStorage(e,o=!0){if("notify_phone_number"===e)return getNotifyPh();const t=kpGetCookieValue(e);if(null==t){return kpGetLocalStorageValue(e,o)}return t}function setValueInCookiesAndLocalStorage(e,o,t=!0,n=365){kpSetCookie(e,o,n),t&&window.localStorage.setItem(e,o),e===XGokwikCoreToken(window.merchantInfo.environment)&&setValueInIDB(e,o)}function kpDeleteLocalStorageValue(e,o=!0){o&&localStorage.removeItem(e)}function kpDeleteCookie(e){document.cookie=e+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;"}function deleteValueFromCookiesAndLocalStorage(e,o=!0){kpDeleteCookie(e),kpDeleteLocalStorageValue(e,o),e===XGokwikCoreToken(window.merchantInfo.environment)&&deleteValueInIDB(e)}function extractRGBValues(e,o=1){const t=e.match(/\d+/g);if(t){return`rgba(${parseInt(t[0])},${parseInt(t[1])},${parseInt(t[2])},${o})`}return null}function findBackgroundColor(e){for(;e;){const o=window.getComputedStyle(e).backgroundColor;if(o&&"rgba(0, 0, 0, 0)"!==o)return o;e=e.parentElement}return"rgba(255,255,255,1)"}function XGokwikCoreToken(e){return"dev"===e||"local"===e||"hdev"===e||"qatwo"===e||"ndev"===e||"idev"===e?"SANDBOXKWIKSESSIONTOKEN":"production"===e||"pci-prod"===e?"KWIKSESSIONTOKEN":"sandbox"===e?"SANDBOXKWIKSESSIONTOKEN":"qa"===e?"QAKWIKSESSIONTOKEN":"SANDBOXKWIKSESSIONTOKEN"}function XGokwikToken(e){return"dev"===e||"local"===e||"hdev"===e||"qatwo"===e||"ndev"===e||"idev"===e?"DEVKWIKUSERTOKEN":"production"===e||"pci-prod"===e?"KWIKUSERTOKEN":"sandbox"===e?"SANDBOXKWIKUSERTOKEN":"qa"===e?"QAKWIKUSERTOKEN":"DEVKWIKUSERTOKEN"}function getKwikpassCheckoutToken(e){switch(e){case"dev":default:return"DEVKWIKPASSTOKEN";case"production":return"KWIKPASSTOKEN";case"sandbox":return"SANDBOXKWIKPASSTOKEN";case"qa":return"QAKWIKPASSTOKEN"}}function hndlRedrctn(e,o=!0){if(sessionStorage.getItem("is_rn_view")){const o=new CustomEvent("kp_redrc",{detail:{rdrct_to:e}});window.dispatchEvent(o)}else if(("/account"===e||e.startsWith("/account/"))&&o){"true"===sessionStorage.getItem("isCustomAccountPage")&&(e="/pages/kp-account"),window.location.href=e}else window.location.href=e}function getNotifyPh(e=null){let o=kpGetLocalStorageValue("notify_phone_number")||kpGetCookieValue("notify_phone_number");if(o){o?.includes("|")||(o=`+91|${val}`);return setValueInCookiesAndLocalStorage("notifyph",btoa(o)),deleteValueFromCookiesAndLocalStorage("notify_phone_number"),o}const t=getValueFromCookiesOrLocalStorage(e||"notifyph");if(t){const e=atob(t).split("|");return 1===e?.length?{country_code:COUNTRY_CODE_INDIA,value:e[0]}:{country_code:e[0],value:e[1]}}return null}function handleLogout(e="/account/logout",o={}){const t=getNotifyPh(),n=new CustomEvent("snowplow_event",{detail:{category:"logged_in_page",action:"click",label:"logout_button_click",property:"phone_number",value:t?.value,country_code:t?.country_code,analyticEvent:CORE_FUNCTION_EVENTS.LOGOUT_BUTTON_CLICK}});window.dispatchEvent(n);const i=new CustomEvent("kp_user_logged_out");window.dispatchEvent(i);const r=document.getElementById("logout-button-desktop"),a=document.getElementById("logout-button-mobile");a&&(a.setAttribute("disabled","disabled"),a.style.opacity="0.7"),r&&(r.setAttribute("disabled","disabled"),r.style.opacity="0.7"),sessionStorage.setItem("isLogout",!0),deleteValueFromCookiesAndLocalStorage(XGokwikToken(window.merchantInfo.environment)),deleteValueFromCookiesAndLocalStorage(XGokwikCoreToken(window.merchantInfo.environment)),deleteValueFromCookiesAndLocalStorage(getKwikpassCheckoutToken(window.merchantInfo.environment)),deleteValueFromCookiesAndLocalStorage("kp_phone_number"),deleteValueFromCookiesAndLocalStorage("isAccountPageLogin"),deleteValueFromCookiesAndLocalStorage("KP_API_KEY"),deleteValueFromCookiesAndLocalStorage("IS_SSO_LOGIN"),deleteValueFromCookiesAndLocalStorage("KC_PHONE"),deleteValueFromCookiesAndLocalStorage("kpToken"),deleteValueFromCookiesAndLocalStorage("idb_ph_no"),sessionStorage.removeItem("isShopifySession"),deleteValueFromCookiesAndLocalStorage("notifyph"),sessionStorage.removeItem(CORE_TOKEN_SESSION_TYPE.KP_SESSION),sessionStorage.removeItem(CORE_TOKEN_SESSION_TYPE.KP_VALID_SESSION),sessionStorage.removeItem("isLoginTagUpdate"),kpDeleteCookie("kp_notification_checked"),sessionStorage.removeItem("KP_CUSTOMER_EMAIL_DATA"),sessionStorage.removeItem("isInternationalUser"),kpDeleteCookie("acs_tkn"),sessionStorage.removeItem("KP_CUSTOMER_EMAIL_DATA_ERROR"),sessionStorage.removeItem("KP_CUSTOMER_EMAIL_DATA_MANUAL_LOGIN"),isDropdownVisible=!1,isDropdownMobileVisible=!1,localStorage.removeItem("kp_email"),localStorage.removeItem("kp_multiple_email"),localStorage.removeItem("kp_customer_id"),localStorage.removeItem("kp_customer_state"),localStorage.removeItem("needsToUpdatePhone"),localStorage.removeItem("SHOPIFY_REDIRECT_LINK"),kpDeleteCookie("coupon_applied","/"),r&&(r.removeAttribute("disabled"),r.style.opacity="1"),a&&(a.removeAttribute("disabled"),a.style.opacity="1");const s=new CustomEvent("snowplow_event",{detail:{category:"logged_in_page",action:"logged_out",label:"successfully_loggedout",property:"phone_number",value:t?.value,country_code:t?.country_code,analyticEvent:CORE_FUNCTION_EVENTS.SUCCESSFULLY_LOGGED_OUT}});window.dispatchEvent(s),"string"!=typeof e&&(e=null),hndlRedrctn(e||"/account/logout")}function handleKpAndShopifyLogin(e,o=!1,t={}){let n=null;e&&(n=e);const i=getValueFromCookiesOrLocalStorage(XGokwikCoreToken(window.merchantInfo.environment)),r=sessionStorage.getItem(CORE_TOKEN_SESSION_TYPE.KP_SESSION),a=getCustomerId();if(i||!a)if(i&&JSON.parse(r)!==CORE_TOKEN_SESSION_TYPE.VERIFIED&&"true"!==sessionStorage.getItem("isLogout"))handleLogout();else if(null===n)if(i&&"true"!==sessionStorage.getItem("isLogout")){const e=new CustomEvent("kp-sso-custom-shopify-login",{detail:{sso_login:!0}});window.dispatchEvent(e)}else{const e=new CustomEvent("open_login_modal",{detail:{customLogin:o,params:t}});window.dispatchEvent(e)}else if(i)a||handleShopifyLogin(null,n);else{const e=new CustomEvent("open_login_modal",{detail:{isKpAndShopifyLogin:!0,redirectLink:n,params:t}});window.dispatchEvent(e)}else{hndlRedrctn(e||"/account",!1)}}function handleShopifyLogin(e,o,t){const n=getValueFromCookiesOrLocalStorage(XGokwikCoreToken(window.merchantInfo.environment)),i=sessionStorage.getItem(CORE_TOKEN_SESSION_TYPE.KP_SESSION),r=getCustomerId();if(n&&null!==r&&kpGetLocalStorageValue("kp_customer_id")!=r&&(window.location.href="/account"),n&&JSON.parse(i)!==CORE_TOKEN_SESSION_TYPE.VERIFIED){if(r){return void hndlRedrctn(o||"/account",!1)}const e=new CustomEvent("open_login_modal",{detail:{isKpAndShopifyLogin:!0,redirectLink:o}});window.dispatchEvent(e)}else{let n=e?.target;if(null===r){const e=new CustomEvent("shopify-session",{detail:{redirectUrl:o,isManualLoginEnable:t}});isElementsWithAccountClickable&&(isElementsWithAccountClickable=!1,n?.classList?.add("kp-disabled-text-color"),setTimeout((()=>{isElementsWithAccountClickable=!0,n?.classList?.remove("kp-disabled-text-color")}),2e3),window.dispatchEvent(e))}else{const e=getNotifyPh(),t=new CustomEvent("snowplow_event",{detail:{category:"logged_in_page",action:"automated",label:"redirected_to_account_page",property:"phone_number",value:e?.value,country_code:e?.country_code,analyticEvent:CORE_FUNCTION_EVENTS.REDIRECRED_TO_ACCOUNT_PAGE}});window.dispatchEvent(t),hndlRedrctn(o)}}}function shopifyCheckout(e){e.preventDefault();const o=new CustomEvent("shopify-session",{detail:{redirectUrl:"/checkout",isManualLoginEnable:!1}});window.dispatchEvent(o)}function kp_trigger_popup(e){if(e){const o=new CustomEvent("open_login_autoload",{detail:{autoloadPopupId:e}});window.dispatchEvent(o)}}function kp_fire_custom_meta_event(e){if(e){const o=new CustomEvent("fire_custom_meta_event",{detail:{eventName:e}});window.dispatchEvent(o)}}function handleDOMUpdate(){token=getValueFromCookiesOrLocalStorage(XGokwikCoreToken(window.merchantInfo.environment));const e=sessionStorage.getItem("isLogout"),o=getValueFromCookiesOrLocalStorage("notify_phone_number");(!token&&!e||token&&!o)&&openIframe("kp_sso_token")}function kpHandleLogin(e,o,t){const n=getValueFromCookiesOrLocalStorage(XGokwikCoreToken(window.merchantInfo.environment)),i=getCustomerId();if(n&&null!=i&&e)hndlRedrctn(e);else{if(i){return void hndlRedrctn(e||"/account",!1)}handleKpAndShopifyLogin(e,o,t)}}window.IS_KP_IFRAME_LOADED=!1,window.KP_MESSAGE_QUEUE=[];const DB_NAME="KP_DB",STORE_NAME="kp_storage",DB_VERSION=1;function openDB(){return new Promise(((e,o)=>{const t=indexedDB.open(DB_NAME,DB_VERSION);t.onupgradeneeded=e=>{const o=e.target.result;o.objectStoreNames.contains(STORE_NAME)||o.createObjectStore(STORE_NAME)},t.onsuccess=()=>{e(t.result)},t.onerror=()=>{o(t.error)}}))}async function setValueInIDB(e,o){const t=(await openDB()).transaction(STORE_NAME,"readwrite");return t.objectStore(STORE_NAME).put(o,e),t.complete||new Promise(((e,o)=>{t.oncomplete=e,t.onerror=o}))}async function deleteValueInIDB(e){const o=(await openDB()).transaction(STORE_NAME,"readwrite");return o.objectStore(STORE_NAME).delete(e),o.complete||new Promise(((e,t)=>{o.oncomplete=e,o.onerror=t}))}function kpExtractUTMParams(e){const o={utm_source:["utm_source","gad_source","fbad_source"],utm_campaign:["utm_campaign","gad_campaignid","utm_campaignid"],utm_medium:["utm_medium","gad_medium","fbad_medium"],utm_content:["utm_content","gad_content","fbad_content"],utm_term:["utm_term","gad_term","fbad_term"]},t=new URL(e).searchParams,n=[];for(const[i,r]of Object.entries(o))for(const o of r){let r=t.get(o);if(null!==r){"utm_source"!==i||e.includes("utm_source")||(e.includes("gclid")||e.includes("gad_source")?r="google":e.includes("fbclid")?r="facebook":e.includes("msclkid")?r="bing":e.includes("li_fat_id")?r="linkedin":(e.includes("tclid")||e.includes("twclid"))&&(r="twitter")),n.push(`${i}=${r}`);break}}return n.join("&")}const kpUtmString=kpExtractUTMParams(window.location.href);kpUtmString&&kpSetCookie("kp_utm_source",encodeURIComponent(kpUtmString),null,!1,30);